<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>A User Guide to the POUMM R-package • POUMM</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="A User Guide to the POUMM R-package">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-129563006-1"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-129563006-1');
</script>
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">POUMM</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">2.1.7</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/UserGuide.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/InterpretingPOUMM.html">Interpreting the POUMM</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>A User Guide to the POUMM R-package</h1>
                        <h4 class="author">Venelin Mitov</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/venelin/POUMM/blob/master/vignettes/UserGuide.Rmd"><code>vignettes/UserGuide.Rmd</code></a></small>
      <div class="hidden name"><code>UserGuide.Rmd</code></div>

    </div>

    
    
<!--
# Copyright 2015-2019 Venelin Mitov
#
# This file is part of POUMM.
#
# POUMM is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# POUMM is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with POUMM  If not, see <http://www.gnu.org/licenses/>.
-->
<p>Here, we introduce the R-package <strong>POUMM</strong> - an implementation of the Phylogenetic Ornstein-Uhlenbeck Mixed Model (POUMM) for univariate continuous traits <span class="citation">(Mitov and Stadler 2018, 2019)</span>. In the sections below, we demonstrate how the package works. To that end, we run a simulation of a trait according to the POUMM model. Then, we execute a maximum likelihood (ML) and a Bayesian (MCMC) POUMM fit to the simulated data. We show how to use plots and some diagnostics to assess the quality of the fit, i.e. the mixing and the convergence of the MCMC, as well as the consistency of the POUMM fit with the true POUMM parameters from the simulation. Once you are familiar with these topics, we recommend reading the vignette <a href="./InterpretingPOUMM.html">Interpreting the POUMM</a>.</p>
<p>But before we start, we need to install and load a few R-packages from CRAN:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="kw"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span>(<span class="st">"data.table"</span>)</span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="kw"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span>(<span class="st">"ggplot2"</span>)</span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="kw"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span>(<span class="st">"lmtest"</span>)</span>
<span id="cb1-4"><a href="#cb1-4"></a><span class="kw"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span>(<span class="st">"ape"</span>)</span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(ggplot2)</span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(data.table)</span>
<span id="cb2-3"><a href="#cb2-3"></a><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(lmtest)</span>
<span id="cb2-4"><a href="#cb2-4"></a><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(ape)</span></code></pre></div>
<div id="Installing" class="section level1">
<h1 class="hasAnchor">
<a href="#Installing" class="anchor"></a>Installing the POUMM R-package</h1>
<p>You can install the most recent version of the package from github:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a>devtools<span class="op">::</span><span class="kw"><a href="https://devtools.r-lib.org//reference/remote-reexports.html">install_github</a></span>(<span class="dt">repo=</span><span class="st">"venelin/POUMM"</span>)</span></code></pre></div>
<p>The above command will install the HEAD version from the master git-branch. This is the package branch, which evolves the fastest and gets the quickest bug-fixes.</p>
<p>A more stable version of the package can be installed from CRAN:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a><span class="kw"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span>(<span class="st">"POUMM"</span>)</span></code></pre></div>
<p>The above commands will install all 3rd party dependencies with one exception: the package for high precision floating point arithmetics (Rmpfr). While the POUMM can be run without Rmpfr installed, installing this package is recommended to prevent numerical instability in some extreme cases, i.e. very small positive values for the POUMM parameters alpha, sigma, and sigmae. Currently, Rmpfr is listed as “Suggests” in POUMM’s DESCRIPTION, since it’s installation has been problematic on some systems (i.e. Linux). If you have not done this before, you may need to enable Rcpp in your R environment. You can read how to do this in the Rcpp-FAQ vignette available from <a href="https://CRAN.R-project.org/package=Rcpp">this page</a>.</p>
<p>Bear in mind that, for CRAN compliance, some of the functionality of the package might not be enabled on some systems, in particular, parallel likelihood calculation on Mac OS X El Capitan using clang compiler prior to version 6 (see the section <a href="#Parallel">Parallel execution</a> below).</p>
</div>
<div id="simulating-trait-evolution-under-the-poumm" class="section level1">
<h1 class="hasAnchor">
<a href="#simulating-trait-evolution-under-the-poumm" class="anchor"></a>Simulating trait evolution under the POUMM</h1>
<div id="parameters-of-the-simulation" class="section level2">
<h2 class="hasAnchor">
<a href="#parameters-of-the-simulation" class="anchor"></a>Parameters of the simulation</h2>
<p>First, we specify the parameters of the POUMM simulation:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a>N &lt;-<span class="st"> </span><span class="dv">500</span></span>
<span id="cb5-2"><a href="#cb5-2"></a>g0 &lt;-<span class="st"> </span><span class="dv">0</span>           </span>
<span id="cb5-3"><a href="#cb5-3"></a>alpha &lt;-<span class="st"> </span><span class="fl">.5</span>        </span>
<span id="cb5-4"><a href="#cb5-4"></a>theta &lt;-<span class="st"> </span><span class="dv">2</span>        </span>
<span id="cb5-5"><a href="#cb5-5"></a>sigma &lt;-<span class="st"> </span><span class="fl">0.2</span>     </span>
<span id="cb5-6"><a href="#cb5-6"></a>sigmae &lt;-<span class="st"> </span><span class="fl">0.2</span> </span></code></pre></div>
<p>We briefly explain the above parameters. The first four of them define an OU-process with initial state <span class="math inline">\(g_0\)</span>, a selection strength parameter, <span class="math inline">\(\alpha\)</span>, a long-term mean, <span class="math inline">\(\theta\)</span>, and a stochastic time-unit standard deviation, <span class="math inline">\(\sigma\)</span>. To get an intuition about the OU-parameters, one can consider random OU-trajectories using the function <code><a href="../reference/rTrajectoryOU.html">rTrajectoryOU()</a></code>. On the figure below, notice that doubling <span class="math inline">\(\alpha\)</span> speeds up the convergence of the trajectory towards <span class="math inline">\(\theta\)</span> (magenta line) while doubling <span class="math inline">\(\sigma\)</span> results in bigger stochastic oscilations (blue line):</p>
<div class="figure">
<img src="UserGuide_files/figure-html/unnamed-chunk-5-1.png" alt="Dashed black and magenta lines denote the deterministic trend towards the long-term mean $\theta$, fixing the stochastic parameter $\sigma=0$." width="672"><p class="caption">
Dashed black and magenta lines denote the deterministic trend towards the long-term mean <span class="math inline">\(\theta\)</span>, fixing the stochastic parameter <span class="math inline">\(\sigma=0\)</span>.
</p>
</div>
<p>The POUMM models the evolution of a continuous trait, <span class="math inline">\(z\)</span>, along a phylogenetic tree, assuming that <span class="math inline">\(z\)</span> is the sum of a genetic (heritable) component, <span class="math inline">\(g\)</span>, and an independent non-heritable (environmental) component, <span class="math inline">\(e\sim N(0,\sigma_e^2)\)</span>. At every branching in the tree, the daughter lineages inherit the <span class="math inline">\(g\)</span>-value of their parent, adding their own environmental component <span class="math inline">\(e\)</span>. The POUMM assumes the genetic component, <span class="math inline">\(g\)</span>, evolves along each lineage according to an OU-process with initial state the <span class="math inline">\(g\)</span> value inherited from the parent-lineage and global parameters <span class="math inline">\(\alpha\)</span>, <span class="math inline">\(\theta\)</span> and <span class="math inline">\(\sigma\)</span>.</p>
</div>
<div id="simulating-the-phylogeny" class="section level2">
<h2 class="hasAnchor">
<a href="#simulating-the-phylogeny" class="anchor"></a>Simulating the phylogeny</h2>
<p>Once the POUMM parameters are specified, we use the <strong>ape</strong> R-package to generate a random tree with 500 tips:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a><span class="co"># Number of tips</span></span>
<span id="cb6-2"><a href="#cb6-2"></a>tree &lt;-<span class="st"> </span><span class="kw">rtree</span>(N)</span>
<span id="cb6-3"><a href="#cb6-3"></a></span>
<span id="cb6-4"><a href="#cb6-4"></a><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(tree, <span class="dt">show.tip.label =</span> <span class="ot">FALSE</span>)</span></code></pre></div>
</div>
<div id="simulating-trait-evolution-on-the-phylogeny" class="section level2">
<h2 class="hasAnchor">
<a href="#simulating-trait-evolution-on-the-phylogeny" class="anchor"></a>Simulating trait evolution on the phylogeny</h2>
<p>Starting from the root value <span class="math inline">\(g_0\)</span>, we simulate the genotypic values, <span class="math inline">\(g\)</span>, and the environmental contributions, <span class="math inline">\(e\)</span>, at all internal nodes down to the tips of the phylogeny:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a><span class="co"># genotypic (heritable) values</span></span>
<span id="cb7-2"><a href="#cb7-2"></a>g &lt;-<span class="st"> </span><span class="kw"><a href="../reference/rVNodesGivenTreePOUMM.html">rVNodesGivenTreePOUMM</a></span>(tree, g0, alpha, theta, sigma)</span>
<span id="cb7-3"><a href="#cb7-3"></a></span>
<span id="cb7-4"><a href="#cb7-4"></a><span class="co"># environmental contributions</span></span>
<span id="cb7-5"><a href="#cb7-5"></a>e &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/length.html">length</a></span>(g), <span class="dv">0</span>, sigmae)</span>
<span id="cb7-6"><a href="#cb7-6"></a></span>
<span id="cb7-7"><a href="#cb7-7"></a><span class="co"># phenotypic values</span></span>
<span id="cb7-8"><a href="#cb7-8"></a>z &lt;-<span class="st"> </span>g <span class="op">+</span><span class="st"> </span>e</span></code></pre></div>
</div>
<div id="visualizing-the-data" class="section level2">
<h2 class="hasAnchor">
<a href="#visualizing-the-data" class="anchor"></a>Visualizing the data</h2>
<p>In most real situations, only the phenotypic value, at the tips, i.e.  will be observable. One useful way to visualize the observed trait-values is to cluster the tips in the tree according to their root-tip distance, and to use box-whisker or violin plots to visualize the trait distribution in each group. This allows to visually assess the trend towards uni-modality and normality of the values - an important prerequisite for the POUMM.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1"></a><span class="co"># This is easily done using the nodeTimes utility function in combination with</span></span>
<span id="cb8-2"><a href="#cb8-2"></a><span class="co"># the cut-function from the base package.</span></span>
<span id="cb8-3"><a href="#cb8-3"></a>data &lt;-<span class="st"> </span><span class="kw">data.table</span>(<span class="dt">z =</span> z[<span class="dv">1</span><span class="op">:</span>N], <span class="dt">t =</span> <span class="kw"><a href="../reference/nodeTimes.html">nodeTimes</a></span>(tree, <span class="dt">tipsOnly =</span> <span class="ot">TRUE</span>))</span>
<span id="cb8-4"><a href="#cb8-4"></a>data &lt;-<span class="st"> </span>data[, group <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/cut.html">cut</a></span>(t, <span class="dt">breaks =</span> <span class="dv">5</span>, <span class="dt">include.lowest =</span> <span class="ot">TRUE</span>)]</span>
<span id="cb8-5"><a href="#cb8-5"></a></span>
<span id="cb8-6"><a href="#cb8-6"></a><span class="kw">ggplot</span>(<span class="dt">data =</span> data, <span class="kw">aes</span>(<span class="dt">x =</span> t, <span class="dt">y =</span> z, <span class="dt">group =</span> group)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb8-7"><a href="#cb8-7"></a><span class="st">  </span><span class="kw">geom_violin</span>(<span class="kw">aes</span>(<span class="dt">col =</span> group)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">col =</span> group), <span class="dt">size=</span>.<span class="dv">5</span>)</span></code></pre></div>
<div class="figure">
<img src="UserGuide_files/figure-html/violin-plots-1.png" alt="Distributions of the trait-values grouped according to their root-tip distances." width="672"><p class="caption">
Distributions of the trait-values grouped according to their root-tip distances.
</p>
</div>
</div>
</div>
<div id="fitting-the-poumm" class="section level1">
<h1 class="hasAnchor">
<a href="#fitting-the-poumm" class="anchor"></a>Fitting the POUMM</h1>
<p>Once all simulated data is available, it is time proceed with a first POUMM fit. This is done easily by calling the function <code><a href="../reference/POUMM.html">POUMM()</a></code>:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1"></a>fitPOUMM &lt;-<span class="st"> </span><span class="kw"><a href="../reference/POUMM.html">POUMM</a></span>(z[<span class="dv">1</span><span class="op">:</span>N], tree)</span></code></pre></div>
<p>The above code runs for about 5 minutes on a MacBook Pro Retina (late 2013) with a 2.3 GHz Intel Core i7 processor. Using default settings, it performs a maximum likelihood (ML) and a Bayesian (MCMC) fit to the data. First the ML-fit is done. Then, three MCMC chains are run as follows: the first MCMC chain samples from the default prior distribution, i.e. assuming a constant POUMM likelihood; the second and the third chains perform adaptive Metropolis sampling from the posterior parameter distribution conditioned on the default prior and the data. By default each chain is run for <span class="math inline">\(10^5\)</span> iterations. This and other default POUMM settings are described in the help-page for the function <code><a href="../reference/specPOUMM.html">specifyPOUMM()</a></code>.</p>
<p>The strategy of executing three MCMC chains instead of one allows to assess:</p>
<ul>
<li>the quality of the MCMC fit: a mismatch between the sampling distributions of the second and third chains suggests that at least one of the chains has not converged to a region of high posterior density (HPD).</li>
<li>the presence of signal for the POUMM parameters in the data: a close match between prior and posterior distributions suggests lack of signal in the data.</li>
</ul>
<p>We plot traces and posterior sample densities from the MCMC fit:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1"></a><span class="co"># get a list of plots </span></span>
<span id="cb10-2"><a href="#cb10-2"></a>plotList &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(fitPOUMM, <span class="dt">showUnivarDensityOnDiag =</span> <span class="ot">TRUE</span>, <span class="dt">doPlot =</span> <span class="ot">FALSE</span>)</span>
<span id="cb10-3"><a href="#cb10-3"></a>plotList<span class="op">$</span>traceplot</span></code></pre></div>
<div class="figure">
<img src="UserGuide_files/figure-html/unnamed-chunk-6-1.png" alt="MCMC traces from a POUMM MCMC-fit." width="691.2"><p class="caption">
MCMC traces from a POUMM MCMC-fit.
</p>
</div>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1"></a>plotList<span class="op">$</span>densplot</span></code></pre></div>
<div class="figure">
<img src="UserGuide_files/figure-html/unnamed-chunk-7-1.png" alt="MCMC univariate density plots. Black dots on the x-axis indicate the ML-fit." width="691.2"><p class="caption">
MCMC univariate density plots. Black dots on the x-axis indicate the ML-fit.
</p>
</div>
<p>A mismatch of the posterior sample density plots from chains 2 and 3, in particular for the phylogenetic heritability, <span class="math inline">\(H_{\bar{t}}^2\)</span>, indicates that the chains have not converged. This can be confirmed quantitatively by the Gelman-Rubin statistic (column called G.R.) in the summary of the fit:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1"></a><span class="kw"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(fitPOUMM)</span></code></pre></div>
<pre><code>##             stat   N       MLE PostMean               HPD    ESS  G.R.
##  1:        alpha 500   0.41430  0.40221     0.1898,0.6705  77.34 1.126
##  2:        theta 500   2.06446  2.08657       1.958,2.248 128.33 1.030
##  3:        sigma 500   0.12321  0.12200   0.07823,0.17237  78.51 1.119
##  4:       sigmae 500   0.19983  0.20199     0.1779,0.2252  99.72 1.083
##  5:          H2e 500   0.43886  0.42389     0.2871,0.5550  99.58 1.100
##  6:       H2tInf 500   0.31451  0.31965     0.1278,0.4446 131.32 1.102
##  7:       H2tMax 500   0.31450  0.31935     0.1278,0.4445 131.24 1.100
##  8:      H2tMean 500   0.31343  0.31641     0.1267,0.4429 130.67 1.096
##  9:           g0 500        NA       NA             NA,NA   0.00    NA
## 10: sigmaG2tMean 500   0.01823  0.01961 0.007174,0.029110 148.95 1.205
## 11:  sigmaG2tMax 500   0.01832  0.02005 0.007235,0.029455 151.11 1.225
## 12:  sigmaG2tInf 500   0.01832  0.02013 0.007236,0.029464 154.32 1.232
## 13:      logpost 500        NA 14.28151      1.609,17.014  36.65 1.315
## 14:       loglik 500  16.32733       NA             NA,NA   0.00    NA
## 15:          AIC 500 -22.65466       NA             NA,NA   0.00    NA
## 16:         AICc 500 -22.53320       NA             NA,NA   0.00    NA</code></pre>
<p>The G.R. diagnostic is used to check whether two random samples originate from the same distribution. Values that are substantially different from 1.00 (in this case greater than 1.01) indicate significant difference between the two samples and possible need to increase the number of MCMC iterations. Therefore, we rerun the fit specifying that each chain should be run for <span class="math inline">\(4 \times 10^5\)</span> iterations:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1"></a>fitPOUMM2 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/POUMM.html">POUMM</a></span>(z[<span class="dv">1</span><span class="op">:</span>N], tree, <span class="dt">spec=</span><span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="dt">nSamplesMCMC =</span> <span class="fl">4e5</span>))  </span></code></pre></div>
<p>Now, both the density plots and the G.R. values indicate nearly perfect convergence of the second and third chains. The agreement between the ML-estimates (black dots on the density plots) and the posterior density modes (approximate location of the peak in the density curves) shows that the prior does not inflict a bias on the MCMC sample. The mismatch between chain 1 and chains 2 and 3 suggests that the information about the POUMM parameters contained in the data disagrees with or significantly improves our prior knowledge about these parameters. This is the desired outcome of a Bayesian fit, in particular, in the case of a weak (non-informed) prior, such as the default one.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1"></a>plotList &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(fitPOUMM2, <span class="dt">doPlot =</span> <span class="ot">FALSE</span>)</span>
<span id="cb15-2"><a href="#cb15-2"></a>plotList<span class="op">$</span>densplot</span></code></pre></div>
<p><img src="UserGuide_files/figure-html/unnamed-chunk-9-1.png" width="691.2"></p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1"></a><span class="kw"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(fitPOUMM2)</span></code></pre></div>
<pre><code>##             stat   N       MLE PostMean               HPD    ESS   G.R.
##  1:        alpha 500   0.41430  0.38942     0.2104,0.5747  720.0 1.0015
##  2:        theta 500   2.06446  2.08602       1.987,2.195  720.0 1.0009
##  3:        sigma 500   0.12321  0.11770   0.07336,0.16939  720.0 0.9986
##  4:       sigmae 500   0.19983  0.20191     0.1802,0.2286  799.1 0.9994
##  5:          H2e 500   0.43886  0.42494     0.2658,0.5435  799.5 0.9999
##  6:       H2tInf 500   0.31451  0.30849     0.1470,0.4694 1274.0 1.0015
##  7:       H2tMax 500   0.31450  0.30831     0.1468,0.4694 1273.0 1.0015
##  8:      H2tMean 500   0.31343  0.30572     0.1437,0.4679 1263.7 1.0013
##  9:           g0 500        NA       NA             NA,NA    0.0     NA
## 10: sigmaG2tMean 500   0.01823  0.01815 0.009029,0.030213 1266.7 1.0053
## 11:  sigmaG2tMax 500   0.01832  0.01838 0.008773,0.030115 1264.1 1.0058
## 12:  sigmaG2tInf 500   0.01832  0.01840 0.008774,0.030178 1264.3 1.0057
## 13:      logpost 500        NA 15.02485       12.17,17.07  720.0 1.0013
## 14:       loglik 500  16.32733       NA             NA,NA    0.0     NA
## 15:          AIC 500 -22.65466       NA             NA,NA    0.0     NA
## 16:         AICc 500 -22.53320       NA             NA,NA    0.0     NA</code></pre>
<div id="consistency-of-the-fit-with-the-true-simulation-parameters" class="section level2">
<h2 class="hasAnchor">
<a href="#consistency-of-the-fit-with-the-true-simulation-parameters" class="anchor"></a>Consistency of the fit with the “true” simulation parameters</h2>
<p>The 95% high posterior density (HPD) intervals contain the true values for all five POUMM parameters (<span class="math inline">\(\alpha\)</span>, <span class="math inline">\(\theta\)</span>, <span class="math inline">\(\sigma\)</span>, <span class="math inline">\(\sigma_e\)</span> and <span class="math inline">\(g_0\)</span>). This is also true for the derived statistics. To check this, we calculate the true derived statistics from the true parameter values and check that these are well within the corresponding HPD intervals:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1"></a>tMean &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(<span class="kw"><a href="../reference/nodeTimes.html">nodeTimes</a></span>(tree, <span class="dt">tipsOnly =</span> <span class="ot">TRUE</span>))</span>
<span id="cb18-2"><a href="#cb18-2"></a>tMax &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="kw"><a href="../reference/nodeTimes.html">nodeTimes</a></span>(tree, <span class="dt">tipsOnly =</span> <span class="ot">TRUE</span>))</span>
<span id="cb18-3"><a href="#cb18-3"></a></span>
<span id="cb18-4"><a href="#cb18-4"></a><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="co"># phylogenetic heritability at mean root-tip distance: </span></span>
<span id="cb18-5"><a href="#cb18-5"></a>  <span class="dt">H2tMean =</span> <span class="kw"><a href="../reference/H2.html">H2</a></span>(alpha, sigma, sigmae, <span class="dt">t =</span> tMean),</span>
<span id="cb18-6"><a href="#cb18-6"></a>  <span class="co"># phylogenetic heritability at long term equilibirium:</span></span>
<span id="cb18-7"><a href="#cb18-7"></a>  <span class="dt">H2tInf =</span> <span class="kw"><a href="../reference/H2.html">H2</a></span>(alpha, sigma, sigmae, <span class="dt">t =</span> <span class="ot">Inf</span>),</span>
<span id="cb18-8"><a href="#cb18-8"></a>  <span class="co"># empirical (time-independent) phylogenetic heritability, </span></span>
<span id="cb18-9"><a href="#cb18-9"></a>  <span class="dt">H2e =</span> <span class="kw"><a href="../reference/PhylogeneticH2.html">H2e</a></span>(z[<span class="dv">1</span><span class="op">:</span>N], sigmae),</span>
<span id="cb18-10"><a href="#cb18-10"></a>  <span class="co"># genotypic variance at mean root-tip distance: </span></span>
<span id="cb18-11"><a href="#cb18-11"></a>  <span class="dt">sigmaG2tMean =</span> <span class="kw"><a href="../reference/OU.html">varOU</a></span>(<span class="dt">t =</span> tMean, alpha, sigma),</span>
<span id="cb18-12"><a href="#cb18-12"></a>  <span class="co"># genotypic variance at max root-tip distance: </span></span>
<span id="cb18-13"><a href="#cb18-13"></a>  <span class="dt">sigmaG2tMean =</span> <span class="kw"><a href="../reference/OU.html">varOU</a></span>(<span class="dt">t =</span> tMax, alpha, sigma),</span>
<span id="cb18-14"><a href="#cb18-14"></a>  <span class="co"># genotypic variance at long-term equilibrium:</span></span>
<span id="cb18-15"><a href="#cb18-15"></a>  <span class="dt">sigmaG2tInf =</span> <span class="kw"><a href="../reference/OU.html">varOU</a></span>(<span class="dt">t =</span> <span class="ot">Inf</span>, alpha, sigma)</span>
<span id="cb18-16"><a href="#cb18-16"></a>  )</span></code></pre></div>
<pre><code>##      H2tMean       H2tInf          H2e sigmaG2tMean sigmaG2tMean  sigmaG2tInf 
##      0.49958      0.50000      0.43792      0.03993      0.04000      0.04000</code></pre>
<p>Finally, we compare the ratio of empirical genotypic to total phenotypic variance with the HPD-interval for the phylogenetic heritability.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1"></a><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dt">H2empirical =</span> <span class="kw"><a href="https://rdrr.io/r/stats/cor.html">var</a></span>(g[<span class="dv">1</span><span class="op">:</span>N])<span class="op">/</span><span class="kw"><a href="https://rdrr.io/r/stats/cor.html">var</a></span>(z[<span class="dv">1</span><span class="op">:</span>N]))</span></code></pre></div>
<pre><code>## H2empirical 
##      0.6541</code></pre>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1"></a><span class="kw"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(fitPOUMM2)[<span class="st">"H2e"</span><span class="op">==</span>stat, <span class="kw"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span>(HPD)]</span></code></pre></div>
<pre><code>##  lower  upper 
## 0.2658 0.5435</code></pre>
</div>
</div>
<div id="Parallel" class="section level1">
<h1 class="hasAnchor">
<a href="#Parallel" class="anchor"></a>Parallel execution</h1>
<p>On computers with multiple core processors, it is possible to speed-up the POUMM-fit by parallelization. The POUMM package supports parallelization on two levels:</p>
<ul>
<li>parallelizing the POUMM likelihood calculation. The POUMM package parallelizes the likelihood calculation through the SPLITT library for parallel lineage traversal <span class="citation">(Mitov and Stadler 2019)</span>. This is a fine grain parallelization, which can benefit from modern single instruction multiple data (SIMD) processors as well as multiple physical cores. Parallelization on multiple cores becomes beneficial on trees exceeding several hundreds tips. For this parallelization to work, the POUMM package must be compiled from source-code using an OpenMP 4.0-enabled C++ compiler. Open MP 4.0 is supported by several modern C++ compilers including Gnu-g++, Intel-icpc and clang version 6.0 or above (see also the <a href="https://venelin.github.io/SPLITT/articles/SPLITT.html#prerequisites">SPLITT Get started guide</a> for details).</li>
</ul>
<p>To control the maximum number of threads (defaults to all physical or virtual cores on the system) by specifying the environment variable OMP_NUM_THREADS, before starting R e.g.:</p>
<pre><code>export OMP_NUM_THREADS=4</code></pre>
<ul>
<li>parallelizing the MCMC-chains - this can be done by creating a <em>cluster</em> using the R-package <code>parallel</code>. With the default settings of the MCMC-fit (executing two MCMC chains sampling from the posterior distribution and one MCMC chain sampling from the prior), this parallelization can result in about two times speed-up of the POUMM fit on a computer with at least two available physical cores.</li>
</ul>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1"></a><span class="co"># set up a parallel cluster on the local computer for parallel MCMC:</span></span>
<span id="cb25-2"><a href="#cb25-2"></a>cluster &lt;-<span class="st"> </span>parallel<span class="op">::</span><span class="kw"><a href="https://rdrr.io/r/parallel/makeCluster.html">makeCluster</a></span>(parallel<span class="op">::</span><span class="kw"><a href="https://rdrr.io/r/parallel/detectCores.html">detectCores</a></span>(<span class="dt">logical =</span> <span class="ot">FALSE</span>))</span>
<span id="cb25-3"><a href="#cb25-3"></a>doParallel<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/doParallel/man/registerDoParallel.html">registerDoParallel</a></span>(cluster)</span>
<span id="cb25-4"><a href="#cb25-4"></a></span>
<span id="cb25-5"><a href="#cb25-5"></a>fitPOUMM &lt;-<span class="st"> </span><span class="kw"><a href="../reference/POUMM.html">POUMM</a></span>(z[<span class="dv">1</span><span class="op">:</span>N], tree, <span class="dt">spec=</span><span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="dt">parallelMCMC =</span> <span class="ot">TRUE</span>))</span>
<span id="cb25-6"><a href="#cb25-6"></a></span>
<span id="cb25-7"><a href="#cb25-7"></a><span class="co"># Don't forget to destroy the parallel cluster to avoid leaving zombie worker-processes.</span></span>
<span id="cb25-8"><a href="#cb25-8"></a>parallel<span class="op">::</span><span class="kw"><a href="https://rdrr.io/r/parallel/makeCluster.html">stopCluster</a></span>(cluster)</span></code></pre></div>
<p>It is possible to use this parallelization in combination with parallelization of the likelihood calculation. This, however, has not been tested and, presumably, would be slower than a parallelization on the likelihood level only. It may be appropriate to parallelize the MCMC chains on small trees, since for small trees, the parallel likelihood calculation is not likely to be much faster than a serial mode calculation. In this case the SPLITT library would switch automatically to serial mode, so there will be no parallel CPU at the likelihood level.</p>
</div>
<div id="packages-used" class="section level1">
<h1 class="hasAnchor">
<a href="#packages-used" class="anchor"></a>Packages used</h1>
<p>Apart from base R functionality, the POUMM package uses a number of 3rd party R-packages:</p>
<ul>
<li>For likelihood calculation: Rcpp v1.0.3 <span class="citation">(Eddelbuettel et al. 2017)</span>, Rmpfr v0.8.1 <span class="citation">(Maechler 2016)</span>;</li>
<li>For mcmcSampling: adaptMCMC v1.3 <span class="citation">(Scheidegger 2012)</span>;</li>
<li>For MCMC convergence diagnostics, calculation of MCMC effective sizes and HPD-intervals: coda v0.19.3 <span class="citation">(Plummer et al. 2016)</span>;</li>
<li>For other purposes (parameter transformations and summary statistics): parallel v3.6.3 <span class="citation">(Team, n.d.)</span>, foreach v1.4.8 <span class="citation">(Revolution Analytics and Weston, n.d.)</span>, data.table v1.13.2 <span class="citation">(Dowle and Srinivasan 2016)</span>, Matrix v1.2.18 <span class="citation">(Bates and Maechler 2017)</span>);</li>
<li>For tree processing: ape v5.3 <span class="citation">(Paradis et al. 2016)</span>;</li>
<li>For reporting: data.table v1.13.2 <span class="citation">(Dowle and Srinivasan 2016)</span>, ggplot2 v3.3.0 <span class="citation">(Wickham and Chang 2016)</span>, lmtest v0.9.38 <span class="citation">(Hothorn et al. 2015)</span>;</li>
<li>For testing: testthat v2.3.2 <span class="citation">(Wickham 2016)</span>, mvtnorm v1.1.0 <span class="citation">(Genz et al. 2016)</span>.</li>
</ul>
</div>
<div id="references" class="section level1 unnumbered">
<h1 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h1>
<div id="refs" class="references">
<div id="ref-R-Matrix">
<p>Bates, Douglas, and Martin Maechler. 2017. <em>Matrix: Sparse and Dense Matrix Classes and Methods</em>. <a href="https://CRAN.R-project.org/package=Matrix">https://CRAN.R-project.org/package=Matrix</a>.</p>
</div>
<div id="ref-R-data-table">
<p>Dowle, Matt, and Arun Srinivasan. 2016. <em>Data.table: Extension of ‘Data.frame‘</em>. <a href="https://CRAN.R-project.org/package=data.table">https://CRAN.R-project.org/package=data.table</a>.</p>
</div>
<div id="ref-R-Rcpp">
<p>Eddelbuettel, Dirk, Romain Francois, JJ Allaire, Kevin Ushey, Qiang Kou, Nathan Russell, Douglas Bates, and John Chambers. 2017. <em>Rcpp: Seamless R and C++ Integration</em>. <a href="https://CRAN.R-project.org/package=Rcpp">https://CRAN.R-project.org/package=Rcpp</a>.</p>
</div>
<div id="ref-R-mvtnorm">
<p>Genz, Alan, Frank Bretz, Tetsuhisa Miwa, Xuefei Mi, and Torsten Hothorn. 2016. <em>Mvtnorm: Multivariate Normal and T Distributions</em>. <a href="https://CRAN.R-project.org/package=mvtnorm">https://CRAN.R-project.org/package=mvtnorm</a>.</p>
</div>
<div id="ref-R-lmtest">
<p>Hothorn, Torsten, Achim Zeileis, Richard W. Farebrother, and Clint Cummins. 2015. <em>Lmtest: Testing Linear Regression Models</em>. <a href="https://CRAN.R-project.org/package=lmtest">https://CRAN.R-project.org/package=lmtest</a>.</p>
</div>
<div id="ref-R-Rmpfr">
<p>Maechler, Martin. 2016. <em>Rmpfr: R Mpfr - Multiple Precision Floating-Point Reliable</em>. <a href="https://CRAN.R-project.org/package=Rmpfr">https://CRAN.R-project.org/package=Rmpfr</a>.</p>
</div>
<div id="ref-Mitov:2018co">
<p>Mitov, Venelin, and Tanja Stadler. 2018. “A Practical Guide to Estimating the Heritability of Pathogen Traits.” <em>Molecular Biology and Evolution</em> 35 (3): 756–72. <a href="https://doi.org/10.1093/molbev/msx328">https://doi.org/10.1093/molbev/msx328</a>.</p>
</div>
<div id="ref-Mitov:2017eg">
<p>———. 2019. “Parallel Likelihood Calculation for Phylogenetic Comparative Models: The Splitt C++ Library.” <em>Methods in Ecology and Evolution</em>. <a href="https://doi.org/10.1111/2041-210X.13136">https://doi.org/10.1111/2041-210X.13136</a>.</p>
</div>
<div id="ref-R-ape">
<p>Paradis, Emmanuel, Simon Blomberg, Ben Bolker, Julien Claude, Hoa Sien Cuong, Richard Desper, Gilles Didier, et al. 2016. <em>Ape: Analyses of Phylogenetics and Evolution</em>. <a href="https://CRAN.R-project.org/package=ape">https://CRAN.R-project.org/package=ape</a>.</p>
</div>
<div id="ref-R-coda">
<p>Plummer, Martyn, Nicky Best, Kate Cowles, Karen Vines, Deepayan Sarkar, Douglas Bates, Russell Almond, and Arni Magnusson. 2016. <em>Coda: Output Analysis and Diagnostics for Mcmc</em>. <a href="https://CRAN.R-project.org/package=coda">https://CRAN.R-project.org/package=coda</a>.</p>
</div>
<div id="ref-R-foreach">
<p>Revolution Analytics, and Steve Weston. n.d. <em>Foreach: Provides Foreach Looping Construct for R</em>.</p>
</div>
<div id="ref-R-adaptMCMC">
<p>Scheidegger, Andreas. 2012. <em>AdaptMCMC: Implementation of a Generic Adaptive Monte Carlo Markov Chain Sampler</em>. <a href="https://CRAN.R-project.org/package=adaptMCMC">https://CRAN.R-project.org/package=adaptMCMC</a>.</p>
</div>
<div id="ref-R-parallel">
<p>Team, R Core. n.d. <em>Support for Parallel Computation in R</em>.</p>
</div>
<div id="ref-R-testthat">
<p>Wickham, Hadley. 2016. <em>Testthat: Unit Testing for R</em>. <a href="https://CRAN.R-project.org/package=testthat">https://CRAN.R-project.org/package=testthat</a>.</p>
</div>
<div id="ref-R-ggplot2">
<p>Wickham, Hadley, and Winston Chang. 2016. <em>Ggplot2: Create Elegant Data Visualisations Using the Grammar of Graphics</em>. <a href="https://CRAN.R-project.org/package=ggplot2">https://CRAN.R-project.org/package=ggplot2</a>.</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">

        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#Installing">Installing the POUMM R-package</a></li>
      <li>
<a href="#simulating-trait-evolution-under-the-poumm">Simulating trait evolution under the POUMM</a><ul class="nav nav-pills nav-stacked">
<li><a href="#parameters-of-the-simulation">Parameters of the simulation</a></li>
      <li><a href="#simulating-the-phylogeny">Simulating the phylogeny</a></li>
      <li><a href="#simulating-trait-evolution-on-the-phylogeny">Simulating trait evolution on the phylogeny</a></li>
      <li><a href="#visualizing-the-data">Visualizing the data</a></li>
      </ul>
</li>
      <li>
<a href="#fitting-the-poumm">Fitting the POUMM</a><ul class="nav nav-pills nav-stacked">
<li><a href="#consistency-of-the-fit-with-the-true-simulation-parameters">Consistency of the fit with the “true” simulation parameters</a></li>
      </ul>
</li>
      <li><a href="#Parallel">Parallel execution</a></li>
      <li><a href="#packages-used">Packages used</a></li>
      <li><a href="#references">References</a></li>
      </ul>
</div>
      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by Venelin Mitov.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
