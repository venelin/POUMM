<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>A User Guide to the POUMM R-package • POUMM</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">POUMM</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/UserGuide.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/InterpretingPOUMM.html">Interpreting the POUMM</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>A User Guide to the POUMM R-package</h1>
                        <h4 class="author">Venelin Mitov</h4>
            
          </div>

    
    
<div class="contents">
<p>Here, we introduce the R-package <strong>POUMM</strong> - an implementation of the Phylogenetic Ornstein-Uhlenbeck Mixed Model (POUMM) for univariate continuous traits <span class="citation">(Mitov and Stadler 2017b; Mitov and Stadler 2017a)</span>. In the sections below, we demonstrate how the package works. To that end, we run a simulation of a trait according to the POUMM model. Then, we execute a maximum likelihood (ML) and a Bayesian (MCMC) POUMM fit to the simulated data. We show how to use plots and some diagnostics to assess the quality of the fit, i.e. the mixing and the convergence of the MCMC, as well as the consistency of the POUMM fit with the true POUMM parameters from the simulation. Once you are familiar with these topics, we recommend reading the vignette <a href="./articles/InterpretingPOUMM.html">Interpreting the POUMM</a>.</p>
<p>But before we start, we need to install and load a few R-packages from CRAN:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">install.packages</span>(<span class="st">"TreeSim"</span>)
<span class="kw">install.packages</span>(<span class="st">"data.table"</span>)
<span class="kw">install.packages</span>(<span class="st">"ggplot2"</span>)
<span class="kw">install.packages</span>(<span class="st">"lmtest"</span>)
<span class="kw">install.packages</span>(<span class="st">"ape"</span>)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(TreeSim)
<span class="kw">library</span>(ggplot2)
<span class="kw">library</span>(data.table)
<span class="kw">library</span>(lmtest)
<span class="kw">library</span>(ape)</code></pre></div>
<div id="Installing" class="section level1">
<h1 class="hasAnchor">
<a href="#Installing" class="anchor"></a>Installing the POUMM R-package</h1>
<p>You can install the most recent version of the package from github:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">devtools<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/devtools/topics/install_github">install_github</a></span>(<span class="dt">repo=</span><span class="st">"venelin/POUMM"</span>)</code></pre></div>
<p>The above command will install the HEAD version from the master git-branch. This is the package branch, which evolves the fastest and gets the quickest bug-fixes.</p>
<p>A more stable version of the package can be installed from CRAN:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">install.packages</span>(<span class="st">"POUMM"</span>)</code></pre></div>
<p>The above commands will install all 3rd party dependencies with one exception: the package for high precision floating point arithmetics (Rmpfr). While the POUMM can be run without Rmpfr installed, installing this package is recommended to prevent numerical instability in some extreme cases, i.e. very small positive values for the POUMM parameters alpha, sigma, and sigmae. Currently, Rmpfr is listed as “Suggests” in POUMM’s DESCRIPTION, since it’s installation has been problematic on some systems (i.e. Linux). If you have not done this before, you may need to enable Rcpp in your R environment. You can read how to do this in the Rcpp <a href="https://cran.r-project.org/web/packages/Rcpp/vignettes/Rcpp-FAQ.pdf">FAQ</a>.</p>
<p>Bear in mind that, for CRAN compliance, some of the functionality of the package might not be enabled on some systems, in particular, parallel likelihood calculation on Mac OS X El Capitan using clang compiler (see the section <a href="#Parallel">Parallel execution</a> below).</p>
</div>
<div id="simulating-trait-evolution-under-the-poumm" class="section level1">
<h1 class="hasAnchor">
<a href="#simulating-trait-evolution-under-the-poumm" class="anchor"></a>Simulating trait evolution under the POUMM</h1>
<div id="parameters-of-the-simulation" class="section level2">
<h2 class="hasAnchor">
<a href="#parameters-of-the-simulation" class="anchor"></a>Parameters of the simulation</h2>
<p>First, we specify the parameters of the POUMM simulation:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">N &lt;-<span class="st"> </span><span class="dv">500</span>
g0 &lt;-<span class="st"> </span><span class="dv">0</span>           
alpha &lt;-<span class="st"> </span>.<span class="dv">5</span>        
theta &lt;-<span class="st"> </span><span class="dv">2</span>        
sigma &lt;-<span class="st"> </span><span class="fl">0.2</span>     
sigmae &lt;-<span class="st"> </span><span class="fl">0.2</span> </code></pre></div>
<p>We briefly explain the above parameters. The first four of them define an OU-process with initial state <span class="math inline">\(g_0\)</span>, a selection strength parameter, <span class="math inline">\(\alpha\)</span>, a long-term mean, <span class="math inline">\(\theta\)</span>, and a stochastic time-unit standard deviation, <span class="math inline">\(\sigma\)</span>. To get an intuition about the OU-parameters, one can consider random OU-trajectories using the function <code><a href="../reference/rTrajectoryOU.html">rTrajectoryOU()</a></code>. On the figure below, notice that doubling <span class="math inline">\(\alpha\)</span> speeds up the convergence of the trajectory towards <span class="math inline">\(\theta\)</span> (magenta line) while doubling <span class="math inline">\(\sigma\)</span> results in bigger stochastic oscilations (blue line):</p>
<div class="figure">
<img src="UserGuide_files/figure-html/unnamed-chunk-5-1.png" alt="Dashed black and magenta lines denote the deterministic trend towards the long-term mean $\theta$, fixing the stochastic parameter $\sigma=0$." width="672"><p class="caption">
Dashed black and magenta lines denote the deterministic trend towards the long-term mean <span class="math inline">\(\theta\)</span>, fixing the stochastic parameter <span class="math inline">\(\sigma=0\)</span>.
</p>
</div>
<p>The POUMM models the evolution of a continuous trait, <span class="math inline">\(z\)</span>, along a phylogenetic tree, assuming that <span class="math inline">\(z\)</span> is the sum of a genetic (heritable) component, <span class="math inline">\(g\)</span>, and an independent non-heritable (environmental) component, <span class="math inline">\(e\sim N(0,\sigma_e^2)\)</span>. At every branching in the tree, the daughter lineages inherit the <span class="math inline">\(g\)</span>-value of their parent, adding their own environmental component <span class="math inline">\(e\)</span>. The POUMM assumes the genetic component, <span class="math inline">\(g\)</span>, evolves along each lineage according to an OU-process with initial state the <span class="math inline">\(g\)</span> value inherited from the parent-lineage and global parameters <span class="math inline">\(\alpha\)</span>, <span class="math inline">\(\theta\)</span> and <span class="math inline">\(\sigma\)</span>.</p>
</div>
<div id="simulating-the-phylogeny" class="section level2">
<h2 class="hasAnchor">
<a href="#simulating-the-phylogeny" class="anchor"></a>Simulating the phylogeny</h2>
<p>Once the POUMM parameters are specified, we use the <strong>TreeSim</strong> R-package <span class="citation">(Stadler 2015)</span> to generate a random birth-death tree with 500 tips:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Number of tips</span>
tree &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ape/topics/ladderize">ladderize</a></span>(
  TreeSim<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/TreeSim/topics/sim.bdsky.stt">sim.bdsky.stt</a></span>(N, <span class="dt">lambdasky =</span> <span class="fl">1.6</span>, <span class="dt">deathsky =</span> .<span class="dv">6</span>, 
                         <span class="dt">timesky=</span><span class="kw">c</span>(<span class="dv">0</span>, <span class="ot">Inf</span>), <span class="dt">sampprobsky =</span> <span class="dv">1</span>)[[<span class="dv">1</span>]]
)

<span class="kw">plot</span>(tree, <span class="dt">show.tip.label =</span> <span class="ot">FALSE</span>)</code></pre></div>
</div>
<div id="simulating-trait-evolution-on-the-phylogeny" class="section level2">
<h2 class="hasAnchor">
<a href="#simulating-trait-evolution-on-the-phylogeny" class="anchor"></a>Simulating trait evolution on the phylogeny</h2>
<p>Starting from the root value <span class="math inline">\(g_0\)</span>, we simulate the genotypic values, <span class="math inline">\(g\)</span>, and the environmental contributions, <span class="math inline">\(e\)</span>, at all internal nodes down to the tips of the phylogeny:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># genotypic (heritable) values</span>
g &lt;-<span class="st"> </span><span class="kw"><a href="../reference/rVNodesGivenTreePOUMM.html">rVNodesGivenTreePOUMM</a></span>(tree, g0, alpha, theta, sigma)

<span class="co"># environmental contributions</span>
e &lt;-<span class="st"> </span><span class="kw">rnorm</span>(<span class="kw">length</span>(g), <span class="dv">0</span>, sigmae)

<span class="co"># phenotypic values</span>
z &lt;-<span class="st"> </span>g <span class="op">+</span><span class="st"> </span>e</code></pre></div>
</div>
<div id="visualizing-the-data" class="section level2">
<h2 class="hasAnchor">
<a href="#visualizing-the-data" class="anchor"></a>Visualizing the data</h2>
<p>In most real situations, only the phenotypic value, at the tips, i.e.  will be observable. One useful way to visualize the observed trait-values is to cluster the tips in the tree according to their root-tip distance, and to use box-whisker or violin plots to visualize the trait distribution in each group. This allows to visually assess the trend towards uni-modality and normality of the values - an important prerequisite for the POUMM.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># This is easily done using the nodeTimes utility function in combination with</span>
<span class="co"># the cut-function from the base package.</span>
data &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/data.table/topics/data.table">data.table</a></span>(<span class="dt">z =</span> z[<span class="dv">1</span><span class="op">:</span>N], <span class="dt">t =</span> <span class="kw"><a href="../reference/nodeTimes.html">nodeTimes</a></span>(tree, <span class="dt">tipsOnly =</span> <span class="ot">TRUE</span>))
data &lt;-<span class="st"> </span>data[, group <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">cut</span>(t, <span class="dt">breaks =</span> <span class="dv">5</span>, <span class="dt">include.lowest =</span> <span class="ot">TRUE</span>)]

<span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/ggplot">ggplot</a></span>(<span class="dt">data =</span> data, <span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(<span class="dt">x =</span> t, <span class="dt">y =</span> z, <span class="dt">group =</span> group)) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/geom_violin">geom_violin</a></span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(<span class="dt">col =</span> group)) <span class="op">+</span><span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/geom_point">geom_point</a></span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(<span class="dt">col =</span> group), <span class="dt">size=</span>.<span class="dv">5</span>)</code></pre></div>
<div class="figure">
<img src="UserGuide_files/figure-html/violin-plots-1.png" alt="Distributions of the trait-values grouped according to their root-tip distances." width="672"><p class="caption">
Distributions of the trait-values grouped according to their root-tip distances.
</p>
</div>
</div>
</div>
<div id="fitting-the-poumm" class="section level1">
<h1 class="hasAnchor">
<a href="#fitting-the-poumm" class="anchor"></a>Fitting the POUMM</h1>
<p>Once all simulated data is available, it is time proceed with a first POUMM fit. This is done easily by calling the function <code><a href="../reference/POUMM.html">POUMM()</a></code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">fitPOUMM &lt;-<span class="st"> </span><span class="kw"><a href="../reference/POUMM.html">POUMM</a></span>(z[<span class="dv">1</span><span class="op">:</span>N], tree)</code></pre></div>
<p>The above code runs for about 5 minutes on a MacBook Pro Retina (late 2013) with a 2.3 GHz Intel Core i7 processor. Using default settings, it performs a maximum likelihood (ML) and a Bayesian (MCMC) fit to the data. First the ML-fit is done. Then, three MCMC chains are run as follows: the first MCMC chain samples from the default prior distribution, i.e. assuming a constant POUMM likelihood; the second and the third chains perform adaptive Metropolis sampling from the posterior parameter distribution conditioned on the default prior and the data. By default each chain is run for <span class="math inline">\(10^5\)</span> iterations. This and other default POUMM settings are described in the help-page for the function <code><a href="../reference/specPOUMM.html">specifyPOUMM()</a></code>.</p>
<p>The strategy of executing three MCMC chains instead of one allows to assess:</p>
<ul>
<li>the quality of the MCMC fit: a mismatch between the sampling distributions of the second and third chains suggests that at least one of the chains has not converged to a region of high posterior density (HPD).</li>
<li>the presence of signal for the POUMM parameters in the data: a close match between prior and posterior distributions suggests lack of signal in the data.</li>
</ul>
<p>We plot traces and posterior sample densities from the MCMC fit:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># get a list of plots </span>
plotList &lt;-<span class="st"> </span><span class="kw">plot</span>(fitPOUMM, <span class="dt">showUnivarDensityOnDiag =</span> <span class="ot">TRUE</span>, <span class="dt">doPlot =</span> <span class="ot">FALSE</span>)
plotList<span class="op">$</span>traceplot</code></pre></div>
<div class="figure">
<img src="UserGuide_files/figure-html/unnamed-chunk-6-1.png" alt="MCMC traces from a POUMM MCMC-fit." width="691.2"><p class="caption">
MCMC traces from a POUMM MCMC-fit.
</p>
</div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">plotList<span class="op">$</span>densplot</code></pre></div>
<div class="figure">
<img src="UserGuide_files/figure-html/unnamed-chunk-7-1.png" alt="MCMC univariate density plots. Black dots on the x-axis indicate the ML-fit." width="691.2"><p class="caption">
MCMC univariate density plots. Black dots on the x-axis indicate the ML-fit.
</p>
</div>
<p>A mismatch of the posterior sample density plots from chains 2 and 3, in particular for the phylogenetic heritability, <span class="math inline">\(H_{\bar{t}}^2\)</span>, indicates that the chains have not converged. This can be confirmed quantitatively by the Gelman-Rubin statistic (column called G.R.) in the summary of the fit:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">summary</span>(fitPOUMM)</code></pre></div>
<pre><code>##             stat   N       MLE  PostMean             HPD    ESS  G.R.
##  1:        alpha 500   0.47442   0.47823   0.3127,0.6483 103.94 1.119
##  2:        theta 500   2.04246   2.04767     1.921,2.171 134.72 1.041
##  3:        sigma 500   0.20051   0.20421   0.1527,0.2678 106.16 1.068
##  4:       sigmae 500   0.20521   0.20315   0.1691,0.2399 180.00 1.007
##  5:          H2e 500   0.64114   0.64549   0.5178,0.7633 180.00 1.003
##  6:       H2tInf 500   0.50154   0.51244   0.3266,0.7108 110.66 1.008
##  7:       H2tMax 500   0.50069   0.51113   0.3259,0.7097 110.70 1.008
##  8:      H2tMean 500   0.49921   0.50935   0.3248,0.7079 110.60 1.009
##  9:           g0 500        NA        NA           NA,NA   0.00    NA
## 10: sigmaG2tMean 500   0.04198   0.04410 0.02524,0.06528 117.54 1.020
## 11:  sigmaG2tMax 500   0.04223   0.04443 0.02530,0.06562 118.44 1.019
## 12:  sigmaG2tInf 500   0.04237   0.04467 0.02532,0.06582 119.05 1.019
## 13:      logpost 500        NA -55.74341   -59.56,-53.64  68.76 1.089
## 14:       loglik 500 -53.29615        NA           NA,NA   0.00    NA
## 15:          AIC 500 116.59230        NA           NA,NA   0.00    NA
## 16:         AICc 500 116.71376        NA           NA,NA   0.00    NA
## 17:           g0 500   0.03896        NA           NA,NA   0.00    NA</code></pre>
<p>The G.R. diagnostic is used to check whether two random samples originate from the same distribution. Values that are substantially different from 1.00 (in this case greater than 1.01) indicate significant difference between the two samples and possible need to increase the number of MCMC iterations. Therefore, we rerun the fit specifying that each chain should be run for <span class="math inline">\(4 \times 10^5\)</span> iterations:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">fitPOUMM2 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/POUMM.html">POUMM</a></span>(z[<span class="dv">1</span><span class="op">:</span>N], tree, <span class="dt">spec=</span><span class="kw">list</span>(<span class="dt">nSamplesMCMC =</span> <span class="fl">4e5</span>))  </code></pre></div>
<p>Now, both the density plots and the G.R. values indicate nearly perfect convergence of the second and third chains. The agreement between the ML-estimates (black dots on the density plots) and the posterior density modes (approximate location of the peak in the density curves) shows that the prior does not inflict a bias on the MCMC sample. The mismatch between chain 1 and chains 2 and 3 suggests that the information about the POUMM parameters contained in the data disagrees with or significantly improves our prior knowledge about these parameters. This is the desired outcome of a Bayesian fit, in particular, in the case of a weak (non-informed) prior, such as the default one.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">plotList &lt;-<span class="st"> </span><span class="kw">plot</span>(fitPOUMM2, <span class="dt">doPlot =</span> <span class="ot">FALSE</span>)
plotList<span class="op">$</span>densplot</code></pre></div>
<p><img src="UserGuide_files/figure-html/unnamed-chunk-9-1.png" width="691.2"></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">summary</span>(fitPOUMM2)</code></pre></div>
<pre><code>##             stat   N       MLE  PostMean             HPD   ESS   G.R.
##  1:        alpha 500   0.47442   0.46639   0.3226,0.6197 720.0 0.9998
##  2:        theta 500   2.04246   2.05993     1.944,2.210 720.0 0.9993
##  3:        sigma 500   0.20051   0.19902   0.1375,0.2615 720.0 0.9997
##  4:       sigmae 500   0.20521   0.20537   0.1701,0.2389 849.4 0.9997
##  5:          H2e 500   0.64114   0.63805   0.5214,0.7593 841.5 0.9998
##  6:       H2tInf 500   0.50154   0.50082   0.3126,0.6998 656.0 0.9998
##  7:       H2tMax 500   0.50069   0.49943   0.3000,0.6878 656.6 0.9998
##  8:      H2tMean 500   0.49921   0.49753   0.2965,0.6850 657.2 0.9998
##  9:           g0 500        NA        NA           NA,NA   0.0     NA
## 10: sigmaG2tMean 500   0.04198   0.04287 0.02287,0.06531 642.3 0.9997
## 11:  sigmaG2tMax 500   0.04223   0.04320 0.02283,0.06533 642.3 0.9997
## 12:  sigmaG2tInf 500   0.04237   0.04345 0.02299,0.06541 642.3 0.9997
## 13:      logpost 500        NA -55.54167   -58.38,-53.60 720.0 0.9990
## 14:       loglik 500 -53.29615        NA           NA,NA   0.0     NA
## 15:          AIC 500 116.59230        NA           NA,NA   0.0     NA
## 16:         AICc 500 116.71376        NA           NA,NA   0.0     NA
## 17:           g0 500   0.03896        NA           NA,NA   0.0     NA</code></pre>
<div id="consistency-of-the-fit-with-the-true-simulation-parameters" class="section level2">
<h2 class="hasAnchor">
<a href="#consistency-of-the-fit-with-the-true-simulation-parameters" class="anchor"></a>Consistency of the fit with the “true” simulation parameters</h2>
<p>The 95% high posterior density (HPD) intervals contain the true values for all five POUMM parameters (<span class="math inline">\(\alpha\)</span>, <span class="math inline">\(\theta\)</span>, <span class="math inline">\(\sigma\)</span>, <span class="math inline">\(\sigma_e\)</span> and <span class="math inline">\(g_0\)</span>). This is also true for the derived statistics. To check this, we calculate the true derived statistics from the true parameter values and check that these are well within the corresponding HPD intervals:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">tMean &lt;-<span class="st"> </span><span class="kw">mean</span>(<span class="kw"><a href="../reference/nodeTimes.html">nodeTimes</a></span>(tree, <span class="dt">tipsOnly =</span> <span class="ot">TRUE</span>))
tMax &lt;-<span class="st"> </span><span class="kw">max</span>(<span class="kw"><a href="../reference/nodeTimes.html">nodeTimes</a></span>(tree, <span class="dt">tipsOnly =</span> <span class="ot">TRUE</span>))

<span class="kw">c</span>(<span class="co"># phylogenetic heritability at mean root-tip distance: </span>
  <span class="dt">H2tMean =</span> <span class="kw"><a href="../reference/H2.html">H2</a></span>(alpha, sigma, sigmae, <span class="dt">t =</span> tMean),
  <span class="co"># phylogenetic heritability at long term equilibirium:</span>
  <span class="dt">H2tInf =</span> <span class="kw"><a href="../reference/H2.html">H2</a></span>(alpha, sigma, sigmae, <span class="dt">t =</span> <span class="ot">Inf</span>),
  <span class="co"># empirical (time-independent) phylogenetic heritability, </span>
  <span class="dt">H2e =</span> <span class="kw"><a href="../reference/PhylogeneticH2.html">H2e</a></span>(z[<span class="dv">1</span><span class="op">:</span>N], sigmae),
  <span class="co"># genotypic variance at mean root-tip distance: </span>
  <span class="dt">sigmaG2tMean =</span> <span class="kw"><a href="../reference/OU.html">varOU</a></span>(<span class="dt">t =</span> tMean, alpha, sigma),
  <span class="co"># genotypic variance at max root-tip distance: </span>
  <span class="dt">sigmaG2tMean =</span> <span class="kw"><a href="../reference/OU.html">varOU</a></span>(<span class="dt">t =</span> tMax, alpha, sigma),
  <span class="co"># genotypic variance at long-term equilibrium:</span>
  <span class="dt">sigmaG2tInf =</span> <span class="kw"><a href="../reference/OU.html">varOU</a></span>(<span class="dt">t =</span> <span class="ot">Inf</span>, alpha, sigma)
  )</code></pre></div>
<pre><code>##      H2tMean       H2tInf          H2e sigmaG2tMean sigmaG2tMean 
##      0.49820      0.50000      0.65914      0.03971      0.03990 
##  sigmaG2tInf 
##      0.04000</code></pre>
<p>Finally, we compare the ratio of empirical genotypic to total phenotypic variance with the HPD-interval for the phylogenetic heritability.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">c</span>(<span class="dt">H2empirical =</span> <span class="kw">var</span>(g[<span class="dv">1</span><span class="op">:</span>N])<span class="op">/</span><span class="kw">var</span>(z[<span class="dv">1</span><span class="op">:</span>N]))</code></pre></div>
<pre><code>## H2empirical 
##      0.6791</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">summary</span>(fitPOUMM2)[<span class="st">"H2e"</span><span class="op">==</span>stat, <span class="kw">unlist</span>(HPD)]</code></pre></div>
<pre><code>##  lower  upper 
## 0.5214 0.7593</code></pre>
</div>
</div>
<div id="Parallel" class="section level1">
<h1 class="hasAnchor">
<a href="#Parallel" class="anchor"></a>Parallel execution</h1>
<p>On computers with multiple core processors, it is possible to speed-up the POUMM-fit by parallelization. The POUMM package supports parallelization on two levels:</p>
<ul>
<li>parallelizing the POUMM likelihood calculation. The POUMM package parallelizes the likelihood calculation through the SPLiTTree library for parallel lineage traversal <span class="citation">(Mitov and Stadler 2017a)</span>. This is a fine grain parallelization, which can benefit from modern single instruction multiple data (SIMD) processors as well as multiple physical cores. Parallelization on multiple cores becomes beneficial on trees exceeding several hundreds tips. For this parallelization to work, the POUMM package must be compiled from source-code using an OpenMP 4.0-enabled C++ compiler. Open MP 4.0 is supported by several modern C++ compilers including Gnu-g++ and Intel-icpc, but not the current version of the <code>clang</code> compiler. We have tested the package on Linux and MacOS X El Capitan using the Intel compiler v16.0.0. To that end, before installing the package from source, we modify the global <code>Makevars</code> file found in the directory <code>.R</code> under the user’s home directory:</li>
</ul>
<pre><code>CPP=cpp
CXX=icpc
CC=icc
SHLIB_CXXLD=icpc -qopenmp</code></pre>
<p>Note that if you are installing the POUMM package from CRAN, on Mac OS X, the above modification of the global <code>Makevars</code> file might still be overwritten by the R-package builder. This is because, for CRAN compliance, the package DESCRIPTION file needs a directive:</p>
<pre><code>SystemRequirements: C++11</code></pre>
<p>On my Mac OS X El Capitan, the above directive forces the use of the <code>clang</code> compiler, which does not support Open MP. Therefore, to enbable using the icpc and the Open MP, I recommend installing the package from github.</p>
<p>To control the maximum number of threads (defaults to all physical or virtual cores on the system) by specifying the environment variable OMP_NUM_THREADS, before starting R e.g.:</p>
<pre><code>export OMP_NUM_THREADS=4</code></pre>
<ul>
<li>parallelizing the MCMC-chains - this can be done by creating a <em>cluster</em> using the R-package <code>parallel</code>. With the default settings of the MCMC-fit (executing two MCMC chains sampling from the posterior distribution and one MCMC chain sampling from the prior), this parallelization can result in about two times speed-up of the POUMM fit on a computer with at least two available physical cores.</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># set up a parallel cluster on the local computer for parallel MCMC:</span>
cluster &lt;-<span class="st"> </span>parallel<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/parallel/topics/makeCluster">makeCluster</a></span>(parallel<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/parallel/topics/detectCores">detectCores</a></span>(<span class="dt">logical =</span> <span class="ot">FALSE</span>))
doParallel<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/doParallel/topics/registerDoParallel">registerDoParallel</a></span>(cluster)

fitPOUMM &lt;-<span class="st"> </span><span class="kw"><a href="../reference/POUMM.html">POUMM</a></span>(z[<span class="dv">1</span><span class="op">:</span>N], tree, <span class="dt">spec=</span><span class="kw">list</span>(<span class="dt">parallelMCMC =</span> <span class="ot">TRUE</span>))

<span class="co"># Don't forget to destroy the parallel cluster to avoid leaving zombie worker-processes.</span>
parallel<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/parallel/topics/makeCluster">stopCluster</a></span>(cluster)</code></pre></div>
<p>It is possible to use this parallelization in combination with parallelization of the likelihood calculation. This, however, has not been tested and, presumably, would be slower than a parallelization on the likelihood level only. It may be appropriate to parallelize the MCMC chains on small trees, since for small trees, the parallel likelihood calculation is not likely to be much faster than a serial mode calculation. In this case the SPLiTTree library would switch automatically to serial mode, so there will be no parallel CPU at the likelihood level.</p>
</div>
<div id="packages-used" class="section level1">
<h1 class="hasAnchor">
<a href="#packages-used" class="anchor"></a>Packages used</h1>
<p>Apart from base R functionality, the POUMM package uses a number of 3rd party R-packages:</p>
<ul>
<li>For likelihood calculation: Rcpp v0.12.14 <span class="citation">(Eddelbuettel et al. 2017)</span>, RcppArmadillo v0.8.300.1.0 <span class="citation">(Eddelbuettel, Francois, and Bates 2016)</span>, Rmpfr v0.6.1 <span class="citation">(Maechler 2016)</span>;</li>
<li>For mcmcSampling: adaptMCMC v1.2 <span class="citation">(Scheidegger 2012)</span>;</li>
<li>For MCMC convergence diagnostics, calculation of MCMC effective sizes and HPD-intervals: coda v0.19.1 <span class="citation">(Plummer et al. 2016)</span>;</li>
<li>For other purposes (parameter transformations and summary statistics): parallel v3.3.3 <span class="citation">(Team, n.d.)</span>, foreach v1.4.4 <span class="citation">(Revolution Analytics and Weston, n.d.)</span>, data.table v1.10.4.3 <span class="citation">(Dowle and Srinivasan 2016)</span>, Matrix v1.2.8 <span class="citation">(Bates and Maechler 2017)</span>, gsl v1.9.10.3 <span class="citation">(Duncan Murdoch and Andrew Clausen 2017)</span>);</li>
<li>For tree processing: ape v5.0 <span class="citation">(Paradis et al. 2016)</span>;</li>
<li>For reporting: data.table v1.10.4.3 <span class="citation">(Dowle and Srinivasan 2016)</span>, ggplot2 v2.2.1 <span class="citation">(Wickham and Chang 2016)</span>, GGally v1.3.2 <span class="citation">(Schloerke et al. 2016)</span>, lmtest v0.9.35 <span class="citation">(Hothorn et al. 2015)</span>;</li>
<li>For testing: testthat v1.0.2 <span class="citation">(Wickham 2016)</span>, mvtnorm v1.0.5 <span class="citation">(Genz et al. 2016)</span>, TreeSim v2.3 <span class="citation">(Stadler 2015)</span>.</li>
</ul>
</div>
<div id="references" class="section level1 unnumbered">
<h1 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h1>
<div id="refs" class="references">
<div id="ref-R-Matrix">
<p>Bates, Douglas, and Martin Maechler. 2017. <em>Matrix: Sparse and Dense Matrix Classes and Methods</em>. <a href="https://CRAN.R-project.org/package=Matrix" class="uri">https://CRAN.R-project.org/package=Matrix</a>.</p>
</div>
<div id="ref-R-data-table">
<p>Dowle, Matt, and Arun Srinivasan. 2016. <em>Data.table: Extension of ‘Data.frame‘</em>. <a href="https://CRAN.R-project.org/package=data.table" class="uri">https://CRAN.R-project.org/package=data.table</a>.</p>
</div>
<div id="ref-R-gsl">
<p>Duncan Murdoch, Robin K. S. Hankin; qrng functions by, and multimin by Andrew Clausen. 2017. <em>Gsl: Wrapper for the Gnu Scientific Library</em>. <a href="https://CRAN.R-project.org/package=gsl" class="uri">https://CRAN.R-project.org/package=gsl</a>.</p>
</div>
<div id="ref-R-Rcpp">
<p>Eddelbuettel, Dirk, Romain Francois, JJ Allaire, Kevin Ushey, Qiang Kou, Nathan Russell, Douglas Bates, and John Chambers. 2017. <em>Rcpp: Seamless R and C++ Integration</em>. <a href="https://CRAN.R-project.org/package=Rcpp" class="uri">https://CRAN.R-project.org/package=Rcpp</a>.</p>
</div>
<div id="ref-R-RcppArmadillo">
<p>Eddelbuettel, Dirk, Romain Francois, and Doug Bates. 2016. <em>RcppArmadillo: ’Rcpp’ Integration for the ’Armadillo’ Templated Linear Algebra Library</em>. <a href="https://CRAN.R-project.org/package=RcppArmadillo" class="uri">https://CRAN.R-project.org/package=RcppArmadillo</a>.</p>
</div>
<div id="ref-R-mvtnorm">
<p>Genz, Alan, Frank Bretz, Tetsuhisa Miwa, Xuefei Mi, and Torsten Hothorn. 2016. <em>Mvtnorm: Multivariate Normal and T Distributions</em>. <a href="https://CRAN.R-project.org/package=mvtnorm" class="uri">https://CRAN.R-project.org/package=mvtnorm</a>.</p>
</div>
<div id="ref-R-lmtest">
<p>Hothorn, Torsten, Achim Zeileis, Richard W. Farebrother, and Clint Cummins. 2015. <em>Lmtest: Testing Linear Regression Models</em>. <a href="https://CRAN.R-project.org/package=lmtest" class="uri">https://CRAN.R-project.org/package=lmtest</a>.</p>
</div>
<div id="ref-R-Rmpfr">
<p>Maechler, Martin. 2016. <em>Rmpfr: R Mpfr - Multiple Precision Floating-Point Reliable</em>. <a href="https://CRAN.R-project.org/package=Rmpfr" class="uri">https://CRAN.R-project.org/package=Rmpfr</a>.</p>
</div>
<div id="ref-Mitov235739">
<p>Mitov, Venelin, and Tanja Stadler. 2017a. “Fast Bayesian Inference of Phylogenetic Models Using Parallel Likelihood Calculation and Adaptive Metropolis Sampling.” <em>bioRxiv</em>. Cold Spring Harbor Laboratory. doi:<a href="https://doi.org/10.1101/235739">10.1101/235739</a>.</p>
</div>
<div id="ref-Mitov:2017ku">
<p>———. 2017b. “Fast and Robust Inference of Phylogenetic Ornstein-Uhlenbeck Models Using Parallel Likelihood Calculation.” <em>bioRxiv</em>, mai, 115089.</p>
</div>
<div id="ref-R-ape">
<p>Paradis, Emmanuel, Simon Blomberg, Ben Bolker, Julien Claude, Hoa Sien Cuong, Richard Desper, Gilles Didier, et al. 2016. <em>Ape: Analyses of Phylogenetics and Evolution</em>. <a href="https://CRAN.R-project.org/package=ape" class="uri">https://CRAN.R-project.org/package=ape</a>.</p>
</div>
<div id="ref-R-coda">
<p>Plummer, Martyn, Nicky Best, Kate Cowles, Karen Vines, Deepayan Sarkar, Douglas Bates, Russell Almond, and Arni Magnusson. 2016. <em>Coda: Output Analysis and Diagnostics for Mcmc</em>. <a href="https://CRAN.R-project.org/package=coda" class="uri">https://CRAN.R-project.org/package=coda</a>.</p>
</div>
<div id="ref-R-foreach">
<p>Revolution Analytics, and Steve Weston. n.d. <em>Foreach: Provides Foreach Looping Construct for R</em>.</p>
</div>
<div id="ref-R-adaptMCMC">
<p>Scheidegger, Andreas. 2012. <em>AdaptMCMC: Implementation of a Generic Adaptive Monte Carlo Markov Chain Sampler</em>. <a href="https://CRAN.R-project.org/package=adaptMCMC" class="uri">https://CRAN.R-project.org/package=adaptMCMC</a>.</p>
</div>
<div id="ref-R-GGally">
<p>Schloerke, Barret, Jason Crowley, Di Cook, Francois Briatte, Moritz Marbach, Edwin Thoen, Amos Elberg, and Joseph Larmarange. 2016. <em>GGally: Extension to ’Ggplot2’</em>. <a href="https://CRAN.R-project.org/package=GGally" class="uri">https://CRAN.R-project.org/package=GGally</a>.</p>
</div>
<div id="ref-R-TreeSim">
<p>Stadler, Tanja. 2015. <em>TreeSim: Simulating Phylogenetic Trees</em>. <a href="https://CRAN.R-project.org/package=TreeSim" class="uri">https://CRAN.R-project.org/package=TreeSim</a>.</p>
</div>
<div id="ref-R-parallel">
<p>Team, R Core. n.d. <em>Support for Parallel Computation in R</em>.</p>
</div>
<div id="ref-R-testthat">
<p>Wickham, Hadley. 2016. <em>Testthat: Unit Testing for R</em>. <a href="https://CRAN.R-project.org/package=testthat" class="uri">https://CRAN.R-project.org/package=testthat</a>.</p>
</div>
<div id="ref-R-ggplot2">
<p>Wickham, Hadley, and Winston Chang. 2016. <em>Ggplot2: Create Elegant Data Visualisations Using the Grammar of Graphics</em>. <a href="https://CRAN.R-project.org/package=ggplot2" class="uri">https://CRAN.R-project.org/package=ggplot2</a>.</p>
</div>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#Installing">Installing the POUMM R-package</a></li>
      <li>
<a href="#simulating-trait-evolution-under-the-poumm">Simulating trait evolution under the POUMM</a><ul class="nav nav-pills nav-stacked">
<li><a href="#parameters-of-the-simulation">Parameters of the simulation</a></li>
      <li><a href="#simulating-the-phylogeny">Simulating the phylogeny</a></li>
      <li><a href="#simulating-trait-evolution-on-the-phylogeny">Simulating trait evolution on the phylogeny</a></li>
      <li><a href="#visualizing-the-data">Visualizing the data</a></li>
      </ul>
</li>
      <li>
<a href="#fitting-the-poumm">Fitting the POUMM</a><ul class="nav nav-pills nav-stacked">
<li><a href="#consistency-of-the-fit-with-the-true-simulation-parameters">Consistency of the fit with the “true” simulation parameters</a></li>
      </ul>
</li>
      <li><a href="#Parallel">Parallel execution</a></li>
      <li><a href="#packages-used">Packages used</a></li>
      <li><a href="#references">References</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Venelin Mitov.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>
